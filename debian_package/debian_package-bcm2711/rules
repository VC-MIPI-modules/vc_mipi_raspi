#!/usr/bin/make -f

KERNEL_HEADERS ?= $(shell echo $(DEB_BUILD_OPTIONS) | grep -oP 'KERNEL_HEADERS=\K[^ ]+')

PACKAGE_DIR := $(CURDIR)/debian/tmp/vc-mipi-driver-bcm2711-${VERSION_DEB_PACKAGE}
DEST_SRC_DIR := $(CURDIR)/debian/tmp/usr/src/vc-mipi-driver-bcm2711-${VERSION_DEB_PACKAGE}
DEST_BOOT_DIR := $(CURDIR)/debian/tmp/boot/
DEST_DKMS_DIR := $(CURDIR)/debian/tmp/usr/share/vc-mipi-driver-bcm2711-dkms/

%:
	dh $@

override_dh_auto_clean:
	cd src && $(MAKE) clean

override_dh_auto_build:
	cd src && $(MAKE) dtbo

override_dh_auto_install:

	# Divert the files to prevent dpkg from making backup links
	dpkg-divert --local --rename --add /boot/firmware/config_vc-mipi-driver-bcm2711.txt
	# Install to tmp directory with verbose output

	mkdir -p $(PACKAGE_DIR)
	mkdir -p $(DEST_SRC_DIR)
	mkdir -p $(DEST_DKMS_DIR)/overlays/
	mkdir -p $(CURDIR)/debian/tmp/usr/local/bin/
	mkdir -p $(DEST_BOOT_DIR)/firmware/overlays/
	mkdir -p $(DEST_DKMS_DIR)/debian/ 


	cp dkms.conf $(DEST_SRC_DIR)
	cp -rv src/* $(DEST_SRC_DIR)

	# Device Tree Files
	cd $(DEST_SRC_DIR)/overlays && $(MAKE) all

	cp src/overlays/config_vc-mipi-driver-bcm2711.txt $(DEST_BOOT_DIR)/firmware/
	chmod 644 $(DEST_BOOT_DIR)/firmware/config_vc-mipi-driver-bcm2711.txt
	cp src/vc-config $(CURDIR)/debian/tmp/usr/local/bin/
	chmod 755 $(CURDIR)/debian/tmp/usr/local/bin/vc-config

	cp debian/postinst $(DEST_DKMS_DIR)/debian/ 
	cp debian/postrm $(DEST_DKMS_DIR)/debian/ 
	chmod 755 $(DEST_DKMS_DIR)/debian/postinst
	chmod 755 $(DEST_DKMS_DIR)/debian/postrm	

	chmod -R 644 $(DEST_BOOT_DIR)/firmware/overlays/
	
	# Ensure the file is copied before running dh_install
	dh_install --sourcedir=$(CURDIR)/debian/tmp --verbose 

	# Undivert the files after installation
	dpkg-divert --local --rename --remove /boot/firmware/config_vc-mipi-driver-bcm2711.txt

override_dh_missing:
	dh_missing --fail-missing

override_dh_install:
	dh_install --sourcedir=debian/tmp --verbose 

override_dh_usrlocal:
    # Empty override to prevent dh_usrlocal from running